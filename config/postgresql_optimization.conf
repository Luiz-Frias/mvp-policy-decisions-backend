# PostgreSQL Configuration Optimizations for Wave 2.5
# Based on Agent 03 Connection Pool Specialist Audit Recommendations
# Target: Support 10,000 concurrent users with <100ms P95 latency

# Connection Settings
# Increased from 100 to 300 as per audit recommendations
max_connections = 300

# Shared Memory Settings
shared_buffers = 4GB              # 25% of system memory (assuming 16GB)
effective_cache_size = 12GB       # 75% of system memory
maintenance_work_mem = 1GB        # For VACUUM, CREATE INDEX
work_mem = 32MB                   # Per-operation memory
wal_buffers = 16MB               # Write-ahead log buffer

# Checkpoint Settings
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
max_wal_size = 4GB
min_wal_size = 1GB

# Background Writer
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# Query Planning
random_page_cost = 1.1            # SSD optimized
seq_page_cost = 1.0              # SSD optimized
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025
effective_io_concurrency = 200    # SSD optimized

# Parallel Query Execution
max_worker_processes = 8
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4

# Logging and Monitoring
log_min_duration_statement = 1000  # Log queries longer than 1s
log_checkpoints = on
log_connections = off              # Disable for performance
log_disconnections = off           # Disable for performance
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 0

# Statement Behavior
statement_timeout = 30s            # Global timeout
lock_timeout = 10s                # Lock acquisition timeout
idle_in_transaction_session_timeout = 60s

# Statistics
track_activities = on
track_counts = on
track_io_timing = on              # Important for query analysis
track_functions = all             # Track function statistics

# Autovacuum (critical for OLTP workload)
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s         # More frequent checks
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1   # 10% of table
autovacuum_analyze_scale_factor = 0.05  # 5% of table
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000

# Connection Pooling Compatibility
# These settings help with pgBouncer transaction pooling
default_transaction_isolation = 'read committed'
default_transaction_read_only = off
default_transaction_deferrable = off

# Memory Management
huge_pages = try                  # Use huge pages if available
temp_buffers = 16MB

# Write Performance
synchronous_commit = on           # Can be 'off' for better performance if some data loss is acceptable
wal_compression = on
wal_log_hints = on               # Needed for pg_rewind
wal_level = replica              # For read replicas

# Read Replica Settings (if using streaming replication)
max_wal_senders = 10
wal_keep_segments = 64
hot_standby = on
hot_standby_feedback = on

# Extension Preloading
shared_preload_libraries = 'pg_stat_statements,auto_explain'

# Auto Explain for Slow Queries
auto_explain.log_min_duration = 1000  # 1 second
auto_explain.log_analyze = true
auto_explain.log_buffers = true
auto_explain.log_timing = true
auto_explain.log_triggers = true
auto_explain.log_verbose = true
auto_explain.log_nested_statements = true

# pg_stat_statements
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = off
pg_stat_statements.save = on
