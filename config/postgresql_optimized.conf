# PostgreSQL Configuration Optimized for High Concurrency
# Designed for 10,000 concurrent users with connection pooling

# Connection Settings
max_connections = 200                    # Reduced since using pgBouncer
superuser_reserved_connections = 3

# Memory Settings (assuming 8GB RAM server)
shared_buffers = 2GB                     # 25% of RAM for OLTP workload
effective_cache_size = 6GB               # 75% of RAM
work_mem = 16MB                          # Per operation memory
maintenance_work_mem = 512MB             # For maintenance operations
max_stack_depth = 7MB

# WAL Settings for Performance
wal_buffers = 32MB                       # WAL buffer size
checkpoint_completion_target = 0.9       # Spread out checkpoint I/O
wal_compression = on                     # Compress WAL for storage efficiency
wal_level = replica                      # Support replication

# Query Planning
random_page_cost = 1.1                   # SSD-optimized setting
effective_io_concurrency = 200           # Number of concurrent I/O operations
default_statistics_target = 100          # Statistics collection target

# Concurrency Settings
max_worker_processes = 8                 # Background worker processes
max_parallel_workers_per_gather = 4      # Parallel query workers
max_parallel_workers = 8                 # Total parallel workers
max_parallel_maintenance_workers = 4     # Parallel maintenance workers

# Timeout Settings
statement_timeout = 300000               # 5 minutes max statement time
lock_timeout = 30000                     # 30 seconds max lock wait
idle_in_transaction_session_timeout = 60000  # 1 minute idle transaction timeout

# Logging for Performance Monitoring
log_min_duration_statement = 1000        # Log queries > 1 second
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0                       # Log all temp files
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Query Monitoring
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
track_activity_query_size = 2048

# Autovacuum Settings for High-Update Workload
autovacuum = on
autovacuum_naptime = 30s                 # Run autovacuum more frequently
autovacuum_vacuum_threshold = 40         # Lower threshold for small tables
autovacuum_analyze_threshold = 20
autovacuum_vacuum_scale_factor = 0.1     # More aggressive vacuuming
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 10ms      # Reduce vacuum delay
autovacuum_vacuum_cost_limit = 1000      # Higher cost limit

# Background Writer Settings
bgwriter_delay = 50ms                    # More frequent background writes
bgwriter_lru_maxpages = 200              # More pages per round
bgwriter_lru_multiplier = 4.0            # Aggressive LRU scanning

# Asynchronous I/O Settings
#effective_io_concurrency = 200          # Already set above for SSD
maintenance_io_concurrency = 10

# Connection Pooling Optimizations
tcp_keepalives_idle = 300               # 5 minutes before keepalive
tcp_keepalives_interval = 30            # 30 seconds between keepalives  
tcp_keepalives_count = 3                # 3 failed keepalives = dead

# JIT Settings (disable for consistent performance)
jit = off                               # Disable JIT for predictable performance

# Extension Settings
shared_preload_libraries = 'pg_stat_statements'  # Load performance monitoring

# pg_stat_statements Configuration
pg_stat_statements.max = 10000          # Track more statements
pg_stat_statements.track = all          # Track all statements
pg_stat_statements.track_utility = on   # Track utility statements
pg_stat_statements.save = on            # Persist across restarts

# Additional Performance Settings
huge_pages = try                        # Use huge pages if available
fsync = on                             # Keep data safety
synchronous_commit = on                # Keep transaction safety
full_page_writes = on                  # Prevent partial page writes

# Replication Settings (if using read replicas)
max_wal_senders = 5                    # Support up to 5 replicas
wal_keep_segments = 32                 # Keep WAL segments for replicas
hot_standby = on                       # Allow read queries on standby
hot_standby_feedback = on              # Feedback to prevent conflicts

# Archive Settings (for point-in-time recovery)
# archive_mode = on
# archive_command = 'test ! -f /archive/%f && cp %p /archive/%f'

# Locale and Formatting
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'